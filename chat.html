<!doctype html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدردشة العامة</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
            background: url('https://i.pinimg.com/originals/e4/fa/06/e4fa061200efe8e8b35955892e984e60.gif') no-repeat center center fixed;
            background-size: cover;
            color: white;
            display: flex;
            flex-direction: column;
        }

        #chat-container {
            flex: 1;
            position: relative;
            z-index: 2;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }

        #messages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        #messageInput {
            width: calc(100% - 22px);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
        }

        #sendMessage {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #sendMessage:hover {
            background-color: #45a049;
        }

        #online-users {
            margin-top: 20px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            max-width: 600px;
            margin: 0 auto;
        }

        #online-users h3 {
            margin: 0;
            font-size: 18px;
            color: #FFD700;
        }

        #online-users ul {
            list-style-type: none;
            padding: 0;
            margin: 10px 0 0 0;
        }

        #online-users ul li {
            margin-bottom: 5px;
            color: #ffffff;
            cursor: pointer;
        }

        #online-users ul li:hover {
            text-decoration: underline;
        }

        /* CSS لإظهار نافذة الدردشة الخاصة */
        .chat-popup {
            display: none;
            position: fixed;
            bottom: 0;
            right: 0;
            width: 300px;
            height: 400px;
            border: 1px solid #ccc;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            z-index: 3;
        }

        .chat-popup-header {
            background: #4CAF50;
            padding: 10px;
            color: white;
            text-align: center;
            border-bottom: 1px solid #ccc;
        }

        .chat-popup-body {
            padding: 10px;
            height: calc(100% - 80px);
            overflow-y: auto;
        }

        .chat-popup-footer {
            padding: 10px;
            border-top: 1px solid #ccc;
            display: flex;
        }

        .chat-popup-footer input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
        }

        .chat-popup-footer button {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .chat-popup-footer button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="اكتب رسالتك هنا...">
        <button id="sendMessage">إرسال</button>
    </div>

    <div id="online-users">
        <h3>المتواجدون أونلاين</h3>
        <ul id="usersList"></ul>
    </div>

    <!-- نافذة الدردشة الخاصة -->
    <div id="chat-popup" class="chat-popup">
        <div class="chat-popup-header">
            <span id="chat-with"></span>
            <button onclick="closeChat()" style="float: right;">×</button>
        </div>
        <div class="chat-popup-body" id="private-messages"></div>
        <div class="chat-popup-footer">
            <input type="text" id="privateMessageInput" placeholder="اكتب رسالتك هنا...">
            <button id="sendPrivateMessage">إرسال</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyASFTlsVzm5J0LKVdqq6RDaSxNsg4jkmxY",
            authDomain: "mad-303.firebaseapp.com",
            databaseURL: "https://mad-303-default-rtdb.firebaseio.com",
            projectId: "mad-303",
            storageBucket: "mad-303.appspot.com",
            messagingSenderId: "1054809660443",
            appId: "1:1054809660443:web:3bf16e1a56beefb329ecbe",
            measurementId: "G-W52CXNRJYD"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const messagesRef = ref(database, 'messages');
        const onlineUsersRef = ref(database, 'onlineUsers');

        const username = localStorage.getItem('username') || "مجهول";
        const usercolor = localStorage.getItem('usercolor') || "#000000";

        document.getElementById('sendMessage').addEventListener('click', () => {
            const message = document.getElementById('messageInput').value;
            if (message.trim() !== "") {
                push(messagesRef, { username: username, text: message, color: usercolor });
                document.getElementById('messageInput').value = '';
            }
        });

        onValue(messagesRef, (snapshot) => {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';
            snapshot.forEach((childSnapshot) => {
                const messageData = childSnapshot.val();
                const messageElement = document.createElement('div');
                messageElement.innerHTML = `<strong style="color:${messageData.color};">${messageData.username}:</strong> ${messageData.text}`;
                messagesContainer.appendChild(messageElement);
            });
        });

        const userStatusRef = ref(database, 'onlineUsers/' + username);
        set(userStatusRef, { username: username, color: usercolor });
        onDisconnect(userStatusRef).remove();

        onValue(onlineUsersRef, (snapshot) => {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            snapshot.forEach((childSnapshot) => {
                const userData = childSnapshot.val();
                const userElement = document.createElement('li');
                userElement.style.color = userData.color;
                userElement.textContent = userData.username;
                userElement.addEventListener('click', () => openPrivateChat(userData.username));
                usersList.appendChild(userElement);
            });
        });

        function openPrivateChat(targetUsername) {
            document.getElementById('chat-with').textContent = `الدردشة مع ${targetUsername}`;
            document.getElementById('chat-popup').style.display = 'block';

            const privateMessagesRef = ref(database, `privateMessages/${username}/${targetUsername}`);
            onValue(privateMessagesRef, (snapshot) => {
                const privateMessagesContainer = document.getElementById('private-messages');
                privateMessagesContainer.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const messageData = childSnapshot.val();
                    const messageElement = document.createElement('div');
                    messageElement.innerHTML = `<strong style="color:${messageData.color};">${messageData.username}:</strong> ${messageData.text}`;
                    privateMessagesContainer.appendChild(messageElement);
                });
                privateMessagesContainer.scrollTop = privateMessagesContainer.scrollHeight;
            });

            document.getElementById('sendPrivateMessage').addEventListener('click', () => {
                const privateMessage = document.getElementById('privateMessageInput').value;
                if (privateMessage.trim() !== "") {
                                        push(privateMessagesRef, { username: username, text: privateMessage, color: usercolor });
                    document.getElementById('privateMessageInput').value = ''; // مسح صندوق الرسائل بعد الإرسال
                }
            });
        }

        // إغلاق نافذة الدردشة الخاصة
        function closeChat() {
            document.getElementById('chat-popup').style.display = 'none';
        }
    </script>

</body></html>

                    